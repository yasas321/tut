<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidya | Online Tuition Platform</title>
    <!-- Load Tailwind CSS for modern, dark-themed styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles to enforce dark theme look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }
        /* Style for the main container to shift content for the sidebar */
        .content-area {
            min-height: calc(100vh - 80px); /* Full height minus header */
            transition: margin-left 0.3s ease;
        }
        /* Sidebar transition effect */
        .sidebar {
            width: 250px;
            transition: transform 0.3s ease;
            transform: translateX(0);
        }
        /* Hidden state for sidebar */
        .sidebar.hidden {
            transform: translateX(-100%);
        }
        /* Body shift when sidebar is visible */
        #page-wrapper.sidebar-open .content-area {
            margin-left: 250px;
        }
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }
        .nav-link.active {
            background-color: #333333;
            border-left: 4px solid #06B6D4; /* Cyan accent */
        }
        .content-card {
            border-left: 5px solid #06B6D4;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 antialiased">

    <!-- Global container for sidebar transition -->
    <div id="page-wrapper" class="sidebar-open">
        
        <!-- HEADER (Fixed Top Nav) -->
        <header class="fixed top-0 left-0 right-0 h-16 bg-gray-800 shadow-xl z-50 flex items-center justify-between px-4 lg:px-6">
            <div class="flex items-center space-x-4">
                <button id="sidebarToggle" class="text-white hover:text-cyan-400 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 class="text-xl lg:text-2xl font-bold text-cyan-400">Vidya Tuition Platform</h1>
            </div>

            <div id="authStatus" class="flex items-center space-x-3">
                <!-- Content injected by JavaScript -->
            </div>
        </header>

        <!-- SIDEBAR (Navigation Menu) -->
        <nav id="sidebar" class="sidebar fixed top-0 left-0 h-screen pt-16 bg-gray-800 z-40 shadow-2xl flex flex-col">
            <div class="p-4 border-b border-gray-700">
                <p id="userNameDisplay" class="font-semibold text-lg"></p>
                <p id="userEmailDisplay" class="text-sm text-gray-400"></p>
            </div>
            <div class="flex-grow overflow-y-auto">
                <a href="#dashboard" data-page="dashboard" class="nav-link flex items-center space-x-3 p-4 text-sm font-medium hover:bg-gray-700 active transition duration-150">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span>Dashboard</span>
                </a>
                <a href="#videos" data-page="videos" class="nav-link flex items-center space-x-3 p-4 text-sm font-medium hover:bg-gray-700 transition duration-150">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    <span>Online Videos</span>
                </a>
                <a href="#tutes" data-page="tutes" class="nav-link flex items-center space-x-3 p-4 text-sm font-medium hover:bg-gray-700 transition duration-150">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Tuition Notes (Tutes)</span>
                </a>
                <a href="#profile" data-page="profile" class="nav-link flex items-center space-x-3 p-4 text-sm font-medium hover:bg-gray-700 transition duration-150">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0112 0 4 4 01-4 4zm-7 0a4 4 0112 0 4 4 01-4 4zm-7 0a4 4 0112 0 4 4 01-4 4zm-7 0a4 4 0112 0 4 4 01-4 4zM4 16v-1a4 4 0014-4h2"></path></svg>
                    <span>Profile & Security</span>
                </a>
            </div>
            <button id="signOutBtnSidebar" class="w-full p-4 bg-red-700 hover:bg-red-600 transition font-medium text-sm mt-auto">Sign Out</button>
        </nav>

        <!-- MAIN CONTENT AREA -->
        <main class="content-area pt-20 p-4 lg:p-8">
            <div id="alertContainer" class="fixed top-20 right-4 w-full max-w-sm z-50"></div>
            <div id="appContent">
                <!-- All Page Content will be rendered here by JavaScript -->
            </div>
        </main>
    </div>

    <!-- FIREBASE SDKs (Must use the full, combined SDK for compatibility) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Set Firebase Log Level to Debug for development visibility
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES (MANDATORY INJECTED VALUES) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-tuition-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        // We use Firestore for structured data storage (Users, Content metadata)
        const db = getFirestore(app);

        // --- STATE VARIABLES ---
        let currentUserId = null;
        let userData = {};
        let currentView = 'login'; // Tracks the current page/view

        // --- DOM ELEMENTS ---
        const appContent = document.getElementById('appContent');
        const authStatusDiv = document.getElementById('authStatus');
        const alertContainer = document.getElementById('alertContainer');
        const sidebar = document.getElementById('sidebar');
        const pageWrapper = document.getElementById('page-wrapper');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const userEmailDisplay = document.getElementById('userEmailDisplay');

        // --- UTILITY FUNCTIONS ---

        /**
         * Shows a transient, styled alert message.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function showAlert(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-cyan-600'
            };
            const alertDiv = document.createElement('div');
            alertDiv.className = `p-3 mb-3 rounded-lg shadow-lg text-white ${colors[type]} transition-all duration-300 transform translate-y-0 opacity-100`;
            alertDiv.textContent = message;

            alertContainer.appendChild(alertDiv);

            // Hide and remove after 4 seconds
            setTimeout(() => {
                alertDiv.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => alertDiv.remove(), 500);
            }, 4000);
        }

        /**
         * Clears all content from the main area and sets the page title.
         * @param {string} title - The title of the page to display.
         */
        function renderPageHeader(title) {
            appContent.innerHTML = `<h2 class="text-3xl font-extrabold text-cyan-400 mb-6">${title}</h2>`;
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === currentView) {
                    link.classList.add('active');
                }
            });
        }

        // --- NAVIGATION & ROUTING ---

        /**
         * Renders the current view based on the currentView state.
         */
        function navigateTo(view) {
            currentView = view;
            if (currentUserId) {
                // Authenticated routes
                switch (view) {
                    case 'dashboard': renderDashboard(); break;
                    case 'videos': renderVideosPage(); break;
                    case 'tutes': renderTutesPage(); break;
                    case 'profile': renderProfilePage(); break;
                    default: renderDashboard();
                }
            } else {
                // Public routes
                switch (view) {
                    case 'register': renderRegister(); break;
                    case 'login': renderLogin(); break;
                    default: renderLogin();
                }
            }
        }

        /**
         * Event listener for sidebar navigation links.
         */
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const view = link.dataset.page;
                navigateTo(view);
            });
        });

        // --- AUTHENTICATION HANDLERS ---

        /**
         * Handles user registration.
         */
        async function handleRegister(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            const fullName = e.target.fullName.value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 1. Update user profile (display name)
                await updateProfile(user, { displayName: fullName });

                // 2. Create user document in Firestore for custom data
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/user_data`, 'profile');
                await setDoc(userDocRef, {
                    fullName: fullName,
                    email: user.email,
                    registeredAt: new Date().toISOString()
                }, { merge: true });

                showAlert('Registration successful! Welcome.', 'success');
                // The onAuthStateChanged listener handles navigation to the dashboard
            } catch (error) {
                showAlert(`Registration Failed: ${error.message}`, 'error');
            }
        }

        /**
         * Handles user login.
         */
        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showAlert('Login successful.', 'success');
                // The onAuthStateChanged listener handles navigation to the dashboard
            } catch (error) {
                showAlert(`Login Failed: ${error.message}`, 'error');
            }
        }

        /**
         * Handles user sign out.
         */
        async function handleSignOut() {
            try {
                await signOut(auth);
                showAlert('You have been logged out.', 'info');
                // The onAuthStateChanged listener handles navigation back to login
            } catch (error) {
                showAlert(`Sign out failed: ${error.message}`, 'error');
            }
        }

        // --- FIREBASE AUTH STATE LISTENER (CORE LOGIC) ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                
                // Fetch custom user data from Firestore
                const profileDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/user_data`, 'profile');
                try {
                    const docSnap = await getDoc(profileDocRef);
                    userData = docSnap.exists() ? docSnap.data() : { fullName: user.displayName || 'Student' };
                } catch(e) {
                    console.error("Error fetching user data:", e);
                    userData = { fullName: user.displayName || 'Student' };
                }

                // Update UI elements for authenticated state
                authStatusDiv.innerHTML = `<button id="signOutBtn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">Sign Out</button>`;
                document.getElementById('signOutBtn').addEventListener('click', handleSignOut);
                document.getElementById('signOutBtnSidebar').addEventListener('click', handleSignOut);
                
                sidebar.classList.remove('hidden');
                pageWrapper.classList.add('sidebar-open');
                userNameDisplay.textContent = userData.fullName || user.email;
                userEmailDisplay.textContent = user.email;

                // Navigate to the dashboard if not already on an authenticated page
                if (currentView === 'login' || currentView === 'register') {
                    navigateTo('dashboard');
                } else {
                    navigateTo(currentView); // Re-render current page with new data
                }

            } else {
                // User is signed out
                currentUserId = null;
                userData = {};

                // Update UI elements for public state
                authStatusDiv.innerHTML = `
                    <button onclick="navigateTo('login')" class="bg-cyan-600 hover:bg-cyan-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">Login</button>
                    <button onclick="navigateTo('register')" class="text-cyan-400 hover:text-cyan-300 font-medium py-2 px-4 transition duration-150">Register</button>
                `;
                sidebar.classList.add('hidden');
                pageWrapper.classList.remove('sidebar-open');
                
                navigateTo('login');
            }
        });

        // --- PAGE RENDERING FUNCTIONS ---

        function renderLogin() {
            appContent.innerHTML = `
                <div class="max-w-md mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl mt-16">
                    <h2 class="text-3xl font-extrabold text-white mb-6 text-center">Student Login</h2>
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-400">Email Address</label>
                            <input type="email" id="email" name="email" required class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-400">Password</label>
                            <input type="password" id="password" name="password" required class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 transition duration-150">Sign In</button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-400">
                        Don't have an account? <a href="#" onclick="navigateTo('register')" class="font-medium text-cyan-400 hover:text-cyan-300">Register here</a>
                    </p>
                </div>
            `;
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        function renderRegister() {
             appContent.innerHTML = `
                <div class="max-w-md mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl mt-16">
                    <h2 class="text-3xl font-extrabold text-white mb-6 text-center">New Student Registration</h2>
                    <form id="registerForm" class="space-y-6">
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-400">Full Name</label>
                            <input type="text" id="fullName" name="fullName" required class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-400">Email Address</label>
                            <input type="email" id="email" name="email" required class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-400">Password (min 6 chars)</label>
                            <input type="password" id="password" name="password" required minlength="6" class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 transition duration-150">Register & Sign Up</button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-400">
                        Already have an account? <a href="#" onclick="navigateTo('login')" class="font-medium text-cyan-400 hover:text-cyan-300">Sign in here</a>
                    </p>
                </div>
            `;
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        }

        function renderDashboard() {
            renderPageHeader('Student Dashboard');
            appContent.innerHTML += `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Welcome Card -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg col-span-1 md:col-span-3 border-l-4 border-cyan-400">
                        <h3 class="text-2xl font-bold mb-2">Welcome Back, ${userData.fullName || 'Student'}!</h3>
                        <p class="text-gray-400">You are securely logged into the tuition platform. Check out the latest resources below.</p>
                    </div>

                    <!-- Videos Card -->
                    <div onclick="navigateTo('videos')" class="bg-gray-800 p-6 rounded-xl shadow-lg hover:bg-gray-700 transition duration-200 cursor-pointer content-card">
                        <div class="flex items-center space-x-4">
                            <svg class="w-10 h-10 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            <div>
                                <h3 class="text-xl font-semibold">Online Videos</h3>
                                <p class="text-gray-400">Watch your daily lessons and past classes in real-time.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tutes Card -->
                    <div onclick="navigateTo('tutes')" class="bg-gray-800 p-6 rounded-xl shadow-lg hover:bg-gray-700 transition duration-200 cursor-pointer content-card">
                        <div class="flex items-center space-x-4">
                            <svg class="w-10 h-10 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <div>
                                <h3 class="text-xl font-semibold">Tuition Notes</h3>
                                <p class="text-gray-400">Download the latest lesson notes (Tutes) and handouts.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Card -->
                    <div onclick="navigateTo('profile')" class="bg-gray-800 p-6 rounded-xl shadow-lg hover:bg-gray-700 transition duration-200 cursor-pointer content-card">
                        <div class="flex items-center space-x-4">
                            <svg class="w-10 h-10 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0112 0 4 4 01-4 4zm-7 0a4 4 0112 0 4 4 01-4 4zm-7 0a4 4 0112 0 4 4 01-4 4zm-7 0a4 4 0112 0 4 4 01-4 4zM4 16v-1a4 4 0014-4h2"></path></svg>
                            <div>
                                <h3 class="text-xl font-semibold">Profile Settings</h3>
                                <p class="text-gray-400">Manage your name, email, and password securely.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderVideosPage() {
            renderPageHeader('Daily Online Videos (Real-Time)');
            appContent.innerHTML += `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="videoList">
                    <p class="text-gray-400 col-span-3">Loading videos from database...</p>
                </div>
            `;
            // Call the real-time data listener
            listenForContent('videos');
        }

        function renderTutesPage() {
            renderPageHeader('Tuition Notes & Handouts (Tutes)');
            appContent.innerHTML += `
                <div class="space-y-4" id="tutesList">
                    <p class="text-gray-400">Loading tuition notes from database...</p>
                </div>
            `;
            // Call the real-time data listener
            listenForContent('tutes');
        }
        
        // --- REAL-TIME CONTENT LISTENERS (Firestore) ---

        let unsubscribeContent = null; // Store the listener function

        /**
         * Sets up a real-time listener for content (videos or tutes).
         * @param {string} collectionName - 'videos' or 'tutes'.
         */
        function listenForContent(collectionName) {
            // Unsubscribe from any previous listener before setting a new one
            if (unsubscribeContent) {
                unsubscribeContent();
            }

            const listElementId = collectionName === 'videos' ? 'videoList' : 'tutesList';
            const listElement = document.getElementById(listElementId);
            const contentCollectionRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
            
            // Query: Get all documents, ordered by creation date (newest first)
            const q = query(contentCollectionRef, orderBy('createdAt', 'desc'));

            // Set up the real-time listener
            unsubscribeContent = onSnapshot(q, (snapshot) => {
                if (!listElement) return; // Guard
                
                let html = '';
                if (snapshot.empty) {
                    html = `<p class="text-gray-400 col-span-3">No ${collectionName} found yet. Check back soon!</p>`;
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        html += collectionName === 'videos' 
                            ? createVideoCard(data, doc.id)
                            : createTuteCard(data, doc.id);
                    });
                }
                listElement.innerHTML = html;
            }, (error) => {
                console.error("Error fetching real-time content:", error);
                listElement.innerHTML = `<p class="text-red-500 col-span-3">Error loading content: ${error.message}</p>`;
            });
        }

        function createVideoCard(video, id) {
            // Advanced: Using a placeholder image and a fixed 16:9 ratio
            const placeholder = `https://placehold.co/400x225/2E3A59/FFFFFF?text=${video.title.substring(0, 15)}...`;
            return `
                <div id="video-${id}" class="bg-gray-800 rounded-xl overflow-hidden shadow-lg hover:shadow-cyan-500/50 transition duration-300 cursor-pointer">
                    <div class="relative pt-[56.25%]"> <!-- 16:9 Aspect Ratio -->
                        <img src="${placeholder}" alt="${video.title}" class="absolute top-0 w-full h-full object-cover">
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-white truncate">${video.title}</h3>
                        <p class="text-sm text-gray-400">${video.subject || 'General'}</p>
                        <a href="${video.url}" target="_blank" class="text-sm text-cyan-400 hover:text-cyan-300 mt-2 inline-block font-medium">Watch Now &rarr;</a>
                    </div>
                </div>
            `;
        }

        function createTuteCard(tute, id) {
            return `
                <div id="tute-${id}" class="bg-gray-800 p-5 rounded-xl shadow-lg content-card flex justify-between items-center hover:bg-gray-700 transition duration-200">
                    <div>
                        <h3 class="text-lg font-semibold text-white">${tute.title}</h3>
                        <p class="text-sm text-gray-400">${tute.subject || 'General'} | Uploaded: ${new Date(tute.createdAt).toLocaleDateString()}</p>
                    </div>
                    <a href="${tute.url}" target="_blank" class="flex items-center space-x-2 bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-lg font-medium transition duration-150">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span>Download</span>
                    </a>
                </div>
            `;
        }

        // --- PROFILE MANAGEMENT ---

        function renderProfilePage() {
            renderPageHeader('Profile & Security Settings');
            appContent.innerHTML += `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Profile Editor Form -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-cyan-400 border-b border-gray-700 pb-2">Edit User Profile</h3>
                        <form id="profileEditForm" class="space-y-4">
                            <div>
                                <label for="profileName" class="block text-sm font-medium text-gray-400">Full Name</label>
                                <input type="text" id="profileName" value="${auth.currentUser.displayName || userData.fullName || ''}" required class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-cyan-500 focus:border-cyan-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-400">Email Address (Cannot change)</label>
                                <input type="email" value="${auth.currentUser.email}" disabled class="mt-1 block w-full px-4 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-500 cursor-not-allowed">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 transition duration-150">Save Profile</button>
                        </form>
                    </div>

                    <!-- Password Changer Form -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 text-cyan-400 border-b border-gray-700 pb-2">Change Password</h3>
                        <form id="passwordChangeForm" class="space-y-4">
                            <div>
                                <label for="currentPassword" class="block text-sm font-medium text-gray-400">Current Password</label>
                                <input type="password" id="currentPassword" required class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-cyan-500 focus:border-cyan-500">
                            </div>
                            <div>
                                <label for="newPassword" class="block text-sm font-medium text-gray-400">New Password (min 6 chars)</label>
                                <input type="password" id="newPassword" required minlength="6" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-cyan-500 focus:border-cyan-500">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150">Change Password</button>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('profileEditForm').addEventListener('submit', handleProfileUpdate);
            document.getElementById('passwordChangeForm').addEventListener('submit', handleChangePassword);
        }

        // --- PROFILE/PASSWORD HANDLERS ---

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const newName = e.target.profileName.value;
            const user = auth.currentUser;

            if (newName === user.displayName && newName === userData.fullName) {
                showAlert('No changes detected.', 'info');
                return;
            }

            try {
                // 1. Update Firebase Auth Profile
                await updateProfile(user, { displayName: newName });
                
                // 2. Update Firestore document
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/user_data`, 'profile');
                await setDoc(userDocRef, { fullName: newName }, { merge: true });

                showAlert('Profile updated successfully!', 'success');
                // Force a reload of user data to update the sidebar immediately
                auth.currentUser.reload();
            } catch (error) {
                showAlert(`Profile update failed: ${error.message}`, 'error');
            }
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            const currentPassword = e.target.currentPassword.value;
            const newPassword = e.target.newPassword.value;
            const user = auth.currentUser;

            try {
                // Step 1: Re-authenticate the user (MANDATORY for security-sensitive actions)
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);

                // Step 2: Update the password
                await updatePassword(user, newPassword);

                showAlert('Password changed successfully!', 'success');
                e.target.reset(); // Clear form fields
            } catch (error) {
                if (error.code === 'auth/wrong-password') {
                    showAlert('Current password is incorrect.', 'error');
                } else {
                    showAlert(`Password change failed: ${error.message}`, 'error');
                }
            }
        }
        
        // --- INITIAL AUTHENTICATION AND SETUP ---

        /**
         * Checks for initial Canvas token and signs in or signs in anonymously.
         */
        async function initializeAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with initial custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Initial auth failed:", error);
                // Fallback to anonymous sign-in if token fails
                try {
                    await signInAnonymously(auth);
                } catch (e) {
                    console.error("Anonymous sign-in failed:", e);
                }
            }
        }
        
        // --- UI TOGGLES ---
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
            pageWrapper.classList.toggle('sidebar-open');
        });

        // Start the authentication process
        initializeAuth();
        
    </script>
</body>
</html>
